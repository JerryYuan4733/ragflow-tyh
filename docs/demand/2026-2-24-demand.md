该项目是RAGflow源码+ 独立的后台管理系统。
注意：当前后台管理系统引用的接口是在测试环境上(172.30.2.29:80)的，你需要将其改为引用本地的ragflow的接口，他和ragflow是解耦的，在tyh-rag-platform/目录下。

---

## 1) 你用 API 为什么达不到网页端那种“整套方案感”

API 之所以看起来“不够像网页端”，常见差距在这几类：

1. **没有 Planner/Router（规划器/路由器）**
   网页端通常会先产出“要做哪些步骤”的计划，再逐步执行；而你一次 call 通常直接输出答案。

2. **没有工具链**
   网页端往往会：检索（RAG）、看历史对话、结构化生成（JSON schema）、自检（第二模型/同模型二次校验）等；API 端你得自己把这些串起来。

3. **没有质量门禁（guardrails）**
   比如：没检索到足够证据就拒答；答案必须带引用；敏感信息脱敏；这类规则网页端往往是默认存在的。

> 这也正好对应你要做企业级 RAG：你要把“网页端那些隐形步骤”工程化出来。

---

## 2) 企业内部门知识库：推荐总体架构

### 2.1 关键术语先对齐（第一次出现简释）

* **RAG（Retrieval-Augmented Generation，检索增强生成）**：先从知识库检索证据，再让大模型（**LLM，Large Language Model，大语言模型**）基于证据回答。
* **RBAC（Role-Based Access Control，基于角色访问控制）**：用户 → 角色 → 权限。
* **SSO（Single Sign-On，单点登录）**：用公司统一身份源登录。
* **BFF（Backend For Frontend）**：给前端专用的后端网关层，封装权限与业务编排。

### 2.2 架构分层（强烈建议）

**核心建议：在 RAGFlow 前面加一层 “企业网关/BFF”，不要把所有权限逻辑硬塞进 RAGFlow 核心。**
原因：二开 RAGFlow 时，上游升级会频繁冲突；而 BFF 能把你的企业逻辑“隔离”出来，升级成本低。

```
[浏览器/内网门户]
   |
   | (SSO登录：OIDC/OAuth2)
   v
[Auth & RBAC 服务]  <— 用户/部门/角色/权限（企业自有表）
   |
   v
[BFF/网关]  <— 统一编排：选知识库、检索、回答、自检、反馈写入、统计聚合
   |
   v
[RAGFlow 原生服务]  <— 文档解析/切分/向量化/检索/对话等
   |
   +--> MySQL / Redis / MinIO / 向量索引(ES/Infinity等)  （RAGFlow 依赖项）
```

RAGFlow 支持配置 **OAuth2/OIDC** 第三方登录通道（用于企业 SSO 集成）。([RAGFlow][1])
RAGFlow 也内置了可观测与链路追踪能力，可对检索与生成过程做追踪排障（对企业运维很关键）。([RAGFlow][2])

---

## 3) 多部门知识库隔离：数据隔离策略怎么选

企业内部“不同部门维护各自 KB”，你至少有两种主流隔离模型（云厂商也这样总结）：

### A. Silo（强隔离，推荐优先）

每个部门一个知识库（dataset），对应独立的索引/存储前缀/权限边界。
优点：安全边界清晰、审计容易；缺点：运维对象多一点。
AWS 也明确提到多租户 RAG 的“silo/pool”等模式与用元数据过滤做隔离。([Amazon Web Services, Inc.][3])

> 你这个是企业内部、面向非技术用户，**我建议默认 silo**：每部门一套 dataset/KB，最不容易“串库”。

### B. Pool（共享大库 + 元数据过滤）

所有文档进同一索引，但每条 chunk 都带 `dept_id`/`confidentiality` 等元数据，检索时强制 filter。
优点：资源复用好；缺点：最怕“过滤没执行/漏执行”导致越权。
（做 pool 时，要把“权限当作查询条件的一部分”，而不是事后过滤；业内也反复强调这一点。）([Oso][4])

RAGFlow 侧也提供了“元数据管理与过滤配置”的能力，能用于实现这类过滤策略。([RAGFlow][5])

---

## 4) RBAC 权限方案（按你给的角色体系完善）

你给的 4 档很合理，我建议再加一个“技术运维/工程师”角色，把“业务内容维护”和“系统参数调整”切开（否则管理员权限太大）。

### 4.1 角色与权限（建议的最小可用集合）

| 角色                | 典型人群           | 权限范围（示例）                                     |
| ----------------- | -------------- | -------------------------------------------- |
| Read（查看者/实习生）     | 实习生/新同学        | 仅聊天；只能看到自己可用的 KB 列表；不可看文档列表/不可下载/不可上传        |
| Write-Add（贡献者）    | 初级员工           | 可看 KB 内容列表（不一定能下载原文）；可新增 FAQ/问答条目；可上传“待审核”内容 |
| Write-Edit（编辑者）   | 部门维护人员         | 具备贡献者权限；可编辑/更新/下线内容；可管理元数据（版本、生效期、标签）        |
| Engineer（技术人员）    | 研发/算法/运维       | 可见/可改检索参数、切分策略、重排模型等；可看 tracing；不可随意删库       |
| Admin（部门管理员）      | 部门负责人/KB owner | 拥有编辑者+工程师能力；可授权成员；可删整个部门 KB（高危操作）            |
| SuperAdmin（系统管理员） | 平台管理员          | 跨部门治理：创建部门、全局审计、全局模型配置、紧急封禁等                 |

> 你提到“内部用、不敏感功能前端禁用即可”——**我建议只把“纯 UI 体验类”放前端**（比如按钮灰掉、隐藏菜单）。
> 但凡涉及：**能否看到某 KB、能否检索到某部门文档、能否下载/删除/导出** ——必须后端强制校验，否则用户直接调 API 就绕开了。（多租户 RAG 的越权泄露是最常见事故类型。）([Oso][4])

RAGFlow 自带的 dataset 权限粒度里有 “Only me / Team” 这类共享模式可用作基础能力。([RAGFlow][6])
但你需要关注团队共享/权限在不同版本上的行为与缺陷（社区里确实有人反馈过 team 共享可见性问题），因此企业项目里更建议你在 BFF 层做“最终裁决”。([GitHub][7])

---

## 5) 你要的“快速检验知识库效果 + 迭代优化闭环”：怎么设计

### 5.1 反馈采集（面向非技术用户，必须简单）

在每次回答下方提供：

* 👍 / 👎
* 失败原因（单选/多选）：**没命中资料 / 答非所问 / 引用不对 / 过时 / 编造 / 需要更详细**
* 可选：用户补充正确答案或指向文档链接

RAGFlow 的 chat 界面里已有“thumb up/down”一类反馈入口（社区也有人问这些反馈如何存取），你可以选择复用 UI 或自己在前端实现并写入你的统计表。([GitHub][8])

### 5.2 后台“差评问题”治理看板（给高级权限）

建议你把差评治理做成 3 个队列，运营起来会很顺：

1. **内容缺失队列**：问题集中但检索证据为空/弱
   → 行动：补文档、补 FAQ、补同义词、补结构化条目

2. **检索/切分队列**：有相关文档但老是检索不到
   → 行动：调 chunk（切分）策略、topK、重排（rerank）、元数据过滤条件

3. **生成/幻觉队列**：证据在但回答仍错/编造
   → 行动：加强“引用约束”、加入“回答前自检/证据一致性校验”、低证据拒答

RAGFlow 0.24 也在强调“知识库治理”和“元数据批量管理”，对你做“批量修正/批量打标”很有帮助。([RAGFlow][5])

### 5.3 自动化评估（用于“快速验收”）

除了用户反馈，你还需要一个“可回归”的离线评估：

* 每个部门维护一份 **Eval 问题集**（50~300 条都行，先小再扩）
* 每次知识库更新/参数调整后自动跑一遍：

  * 命中率（检索到正确文档的比例）
  * 引用覆盖率（回答是否引用到关键证据）
  * 低证据拒答率（该拒答时有没有拒答）
  * 延迟/成本（企业里非常现实）

再把线上差评问题按聚类抽样加入 Eval 集，形成“越用越好”的闭环。

---

## 6) 你可以直接用的“提示词模板包”（实现网页端那种“整套方案感”）

我没法展示我内部的系统提示词原文（那是产品级策略的一部分），但我可以给你一套**企业 RAG 通用、可直接落地**的 Prompt 结构——你把它放到 BFF 编排里，就能逼近网页端体验。

### 6.1 Planner（规划器）System Prompt（示例）

目标：把“简单问题”扩展成“完整解决方案”，并明确需要哪些工具（检索/追问/输出格式）。

* 规则要点：

  * 先输出**任务分解**（但不要暴露内部推理过程，输出“步骤清单”即可）
  * 判断是否需要检索；需要的话给出 3~6 个检索 query
  * 要求最终答案结构化（标题/要点/落地步骤/风险点）

### 6.2 Answerer（回答器）System Prompt（示例）

目标：**只基于检索证据回答**，证据不足就拒答，并给出下一步建议。

* 关键约束：

  * “答案必须引用证据（chunk id/文档名）”
  * “证据不足：明确说不知道 + 给出需要补充哪些资料”
  * “不要编造人名、部门名、日期、链接”

### 6.3 Evaluator（自检器）System Prompt（示例）

目标：对 Answerer 输出做审查：

* 是否每个关键结论都有证据
* 是否有越权信息（不该出现的部门/保密级别）
* 是否存在幻觉（证据里没有却说了）

> 这套“三段式（Plan → Answer → Evaluate）”就是你用 API 复刻网页端体验的核心工程化做法。

---

## 7) 优化方向与注意事项（企业级“坑点清单”）

1. **权限校验要进入“检索查询”里**
   不要“先检索再过滤”，要“带过滤条件去检索”（否则性能差且容易漏）。([Oso][4])
2. **把“元数据”当成治理核心**
   部门、版本、生效期、密级、业务线、文档类型……这些元数据决定你后期能不能做精准过滤与回溯。RAGFlow 0.24 也在强化元数据治理与批量管理。([RAGFlow][5])
3. **可观测性先做**
   上线后“为什么答错”最难排。直接接入 Langfuse 这类 tracing，把“检索到什么、重排怎么排、最终 prompt 长什么样”都能追。RAGFlow 文档里有内置集成说明。([RAGFlow][2])
4. **团队共享/权限功能要做版本验证与回归测试**
   社区里确实出现过 team 权限可见性相关问题的反馈，你做企业项目必须把“权限回归”纳入发布流程。([GitHub][7])



## 8）当前进度

目录tyh-rag-platform/ 下是同事之前实现的一个管理系统，但这个管理系统比较简单并且还有很多问题。你可以参考这个管理系统，并且可以直接在这个管理系统上进行大幅度的修改和完善，你可以参考tyh-rag-platform\docs 中的文档来了解这个管理系统实现了什么。



需求：

仔细调研ragflow，并掌握同事的管理系统tyh-rag-platform/ (现在只是demo阶段)，最后完善这个需求文档

注意：当前后台管理系统引用的接口是在测试环境上(172.30.2.29:80)的，之后你需要将其改为引用本地的ragflow的接口，他和ragflow是解耦的，在tyh-rag-platform/目录下。

另外作为算法工程师，我可以在哪些地方进行优化赋能？